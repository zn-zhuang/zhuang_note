# 计算机网络读书笔记



### 第1章. 概述

#### 1.1 计算机网络

计算机网络向用户提供的两个最重要的功能：

- 连通性
- 共享

局部范围互联的计算机网络为互**连**网，而**互联网**是专指`Internet`

**计算机网络**是由若干**结点**和连接这些结点的**链路**组成

网络之间还可通过路由器互连起来，构成更大的网络，称为**互连网**，

网络把许多计算机连接在一起，而互联网则把许多网络通过路由器连接在一起。与网络相连的计算机常称为主机



#### 1.2 因特网概述

因特网发展的三个阶段：

- 第一阶段：从单个网络 ARPANET 向互联网发展的过程。1983 年 TCP/IP 协议成为 ARPANET 上的标准协议。
- 第二阶段：建成三级结构的因特网：主干网、地区网和校园网（或企业网）。
- 第三阶段：形成多层次的ISP（Internet Service Provider 因特网服务提供者）结构的因特网

`Internet` 和 `Internet` 的区别：

- **internet**：通用名词，它泛指由多个计算机网络互连而成的网络，其通信协议不一定用**TCP/IP**
- **Internet**：专用名词，它指当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用 TCP/IP 协议族作为通信的规则，且其前身是美国的 ARPANET。



#### 1.3 互联网的组成

互联网组成可以划分为两大块：

*  **边缘部分**：由所有连接在因特网上的主机组成。这部分由**用户直接使用**，用来进行通信和资源共享。
* **核心部分**：由大量的网络和连接这些网络的路由器组成。这部分是**为边缘部分提供服务的**（提供连通性和交换）

<img src="G:\Typora\Markdown文件\Markdown图片\image-20210104183324171.png" alt="image-20210104183324171" style="zoom:67%;" />

在网络边缘的端系统（主机）之间的通信方式通常可划分为两大类：

*  **客户服务器方式（C/S)**：**客户**和**服务器**是指通信中涉及的两个应用**进程**，**客户**是服务请求方，**服务器**是服务提供方。
* **对等连接方式（P2P)**：对等连接中的每一个主机既是客户又同时是服务器



**核心部分**

*  **电路交换** 的三个阶段：建立连接——通话——释放连接
   在通话时，两用户之间占用端到端的资源，而由于绝大部分时间线路都是空闲的，所以线路的传输速率往往很低。

* **分组交换** 的组成：报文、首部、分组。

  采用**存储转发**技术，即收到分组——存储分组——查询路由（路由选择协议）——转发分组。优点：高效、灵活、迅速、可靠。缺点：时延（分组转发需要排队）、开销（必要的控制信息）。关键构件：**路由器**

发送的整块数据称为一个**报文**，把较长的报文划分为较短的等长数据段，加上必要的控制信息，构成了一个**分组**，分组是互联网中传送的数据单元

**路由器**是一台特殊的计算机



#### 1.4 计算机网络的类别

* 按照网络的作用范围进行分类
  * **广域网WAN**：互联网的核心部分，不同的国家之间
  * **城域网MAN**：作用范围为整个城市，多采用以太网技术
  * **局域网LAN**：如校园网、企业网等
  * **个人局域网PAN**：个人连接起来的

* 按照网络的使用者来分类
  * **公用网**：电信公司出资建造的大型网络
  * **专用网**：某部门不向外人提供服务的自用网



#### 1.5 计算机网络的性能

* **速率**：指连接在计算机网络上的主机在数字信道上传送数据的速率。b/s（bps） 如100M以太网，实际是指100Mb/s。往往是指额定速率或标称速率。

* **带宽**：数字信道所能传送的最高速率。b/s（bps）

* **吞吐量**：单位时间内通过某个网络（或信道、接口）的实际数据量。其绝对上限值等于带宽，衡量CPU、网络拥挤程度和报文段中数据字段的占有份额

* **时延**：数据（一个报文或分组、甚至比特）从网络（或链路）的一段传送到另一端的时间，也称延迟。

  *  发送时延：主机或路由器发送数据帧所需的时间，也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间。也成传输时延。
     发送时延 = 数据帧长度（b） / 信道带宽（b/s）

  * 传播时延：电磁波在信道中传输一定距离所需划分的时间。
     传播时间 = 信道长度（m） / 传输速率（m/s）

  * 处理时延：主机或路由器处理收到的分组所花费的时间。

  *  排队时延：分组在输入队列中等待处理的时间加上其在输出队列中等待转发的时间。

    ***发送时延***决定了总时延的数值

    综上：总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延。
     注：对于高速网络链路，提高的是发送速率而不是传播速率。

* **时延带宽积**：传播时延 * 带宽。表示链路的容量。
* **往返时间RTT**：从发送方发送数据开始，到发送发收到接收方的确认为止，所花费的时间。
* **利用率**：某信道有百分之几是被利用的（有数据通过）。而信道或网络利用率过高会产生非常大的时延。
   当前时延=空闲时时延/（1-利用率）



#### 1.6 计算机网络体系结构

得到最广泛应用的不是法律上的**国际标准OSI**，而是非国际标准**TCP/IP**

**网络协议**：简称协议，是为了进行网络中的数据交换而建立的规则、标准或约定

**体系结构**(architecture)是计算机网络的各层及其协议的集合

**体系结构是抽象的，而实现则是具体的，是真正在运行的计算机硬件和软件**

<img src="G:\Typora\Markdown文件\Markdown图片\image-20210104192911982.png" alt="image-20210104192911982" style="zoom: 80%;" />

**OSI**的协议复杂且不实用，本书采用五层协议

* **应用层**：任务是通过应用进程间的交互来完成特定网络应用，应用层协议定义的是应用进程间通信和交互的规则，常用的应用层协议有`HTTP（万维网）, DNS（域名系统）, SMTP（电邮）`
* **运输层**：负责向两台主机中进程之间的通信提供**数据传输服务**，向上一层的进行通信的两个进程之间提供一个可靠的端对端服务，使它们看不见运输层以下的数据通信的细节，主要使用两种协议：
  * **传输控制协议（TCP/IP）**：提供面向连接的、可靠的数据传输服务，数据传输单位是**报文段**
  * **用户数据报协议（UDP）**：提供无连接的、尽最大努力的数据传输服务（不保证可靠性），数据传输单位是**用户数据报**
* **网络层**：网络层将运输层产生的**报文**或**用户数据报**封装成**分组（IP数据报**）或包进行传送，使用的协议是无连接的**网际协议IP**
* **数据链路层**：将网络层交下来的**IP数据报**组装成**帧**，在两个相邻结点间的链路上”透明“的传送以帧为单位的数据。每一帧包括数据和必要的控制信息。在收到数据时，控制信息使收到端直到哪个帧从哪个比特开始和结束，若数据有差错，则简单丢弃
* **物理层**：物理层的任务就是透明地传送比特流。（注意：传递信息的物理媒体，如双绞线、同轴电缆、光缆等，是在物理层的下面，当做第0 层。）物理层还要确定连接电缆插头的定义及连接法

<img src="G:\Typora\Markdown文件\Markdown图片\image-20210104201432075.png" alt="image-20210104201432075" style="zoom:80%;" />

同样的层次之间，就像把数据通过水平虚线直接传递给对方，这就是所谓的**对等层**之间的通信，各层协议其实就是在各个对等层之间传递数据时的各项规定

<img src="G:\Typora\Markdown文件\Markdown图片\image-20210104202804690.png" alt="image-20210104202804690" style="zoom:80%;" />



### 第2章. 物理层

#### 2.1 物理层基本概念

通信线路上采用**串行传输**（经济考虑）



#### 2.2 数据通信的基础知识

<img src="G:\Typora\Markdown文件\Markdown图片\image-20210104204502081.png" alt="image-20210104204502081" style="zoom:80%;" />

如图所示，一个数据通信系统可划分为三大部分，**源系统、传输系统**和**目的系统**

通信方式

- 单向通信（单工）
- 双向交替通信（半双工）
- 双向同时通信（全双工）

基带信号：来自信源的信号。 带通信号：经过载波条之后的信号。基本带通调制方法：调幅(AM)、调频(FM)、调相(PM)



#### 2.3 物理层下面的传输媒体

<img src="G:\Typora\Markdown文件\Markdown图片\aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTgwMTA1MjIyNDMxNjU2" alt="图片来源网络" style="zoom:80%;" />

导向传输媒体：

 1.1. 双绞线
 双绞线已成为局域网中的主流传输媒体

- **屏蔽双绞线 STP** (Shielded Twisted Pair)
- **无屏蔽双绞线 UTP** (Unshielded Twisted Pair)

1.2. 同轴电缆（目前主要用在有限电视网）

- **细缆**（适合短距离，安装容易，造价低）
- **粗缆**（适合较大局域网，布线距离长，可靠性好）

1.3. 光纤
 光纤有很好的抗电磁干扰特性和很宽的频带，主要用在环形网中

- **多模光纤**（用发光二极管，便宜，定向性较差）
- **单模光纤**（注入激光二极管，定向性好）

1. 非导向传输媒体
    微波、红外线、激光、卫星通信



#### 2.4 信道复用技术

- 频分复用FDM (Frequency Division Multiplexing)：所有用户在同样的时间占用不同的频率带宽资源。
- 时分复用TDM(Time Division Multiplexing)则是将时间划分为一段段等长的时分复用帧（TDM 帧）。
- 统计时分复用 STDM(Statistic TDM)是改进的时分复用，明显地提高信道的利用率。
- 波分复用 WDM (Wavelength Division Multiplexing)：光的频分复用
- 码分复用 CDM (Code Division Multiplexing)常用的名词是**码分多址 CDMA**：有很强的抗干扰能力。



### 第3章. 数据链路层

数据链路层使用的信道主要有以下两种类型：

- 点对点信道
- 广播信道

本章重要内容：

* 数据链路层的点对点信道和广播信道的特点，以及这两种信道所使用的协议（**PPP、CSMA/CD**）的特点
* 数据链路层的三个基本问题：封装成帧、透明传输和差错检测
* 适配器、转发器、集线器、网桥、以太网交换机的作用及使用场所（适配器是数据链路层和物理层。转发器和集线器是物理层，网桥、交换机是数据链路层）



####  3.1 数据链路层的基本概念和基本问题

**链路** ：从一个结点到相邻结点的一段物理线路，链路只是一条路径的某段组成部分

**数据链路** ：把实现这些协议的硬件和软件加载链路上
 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能（就是TCP/IP的链路层）



数据链路层的**三个基本问题**：

* **封装成帧**

  就是在I**P数据报**的前后分别添加首部（帧开始符SOH 01）和尾部（帧结束符EOT 04），然后就构成了一个帧。（数据部分<=长度限制MTU）首部和尾部的一个重要作用就是进行帧定界。 **帧定界是分组交换的必然要求**，帧是数据链路层的数据传送单元。（接收端收到物理层上交的比特流后，就可根据首部和尾部的标记，从收到的比特流中识别出帧的开始和结束）

* **透明传输**
   为了达到透明传输（即传输的数据部分不会因为包含SOH和EOT而出错），在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(十六进制1B) **透明传输避免消息符号与帧定界符号相混淆**

  （当传送的是ASCII码的文本文件时不会出现这样的问题，因为字符中不需要上述的界定符，而当传输的是非ASCII码（如二进制程序），就可能出现，可用上述的方法）

* **差错检测**

  现实通信链路中比特在传输中会产生差错，一段时间内，传输错误的比特占比称为**误码率BER**，为了保证可靠性，通常通过**循环冗余检验CRC**来做差错检测。 **差错检测防止无效数据帧浪费后续路由上的传输和处理资源**

除了以上所说的**比特差错**，还有**传输差错**，包括**帧丢失**，**帧重复**，**帧失序**



#### 3.2 点对点协议PPP==感觉没啥用==

（已丢在候补区）



#### 3.3 使用广播信道的数据链路层

广播信道是一种一对多的通信，局域网（以太网在局域网市场中占据了绝对优势，以太网几乎成为了局域网的同义词）使用的就是广播信道

<img src="Markdown图片/image-20210105151449631.png" alt="image-20210105151449631"  />

局域网工作的层次跨越了数据链路层和物理层

共享信道实现共享媒体资源的方法主要采用**随机接入**，若多用户的信息发生碰撞，则需解决碰撞的网络协议

![image-20210105152757712](Markdown图片/image-20210105152757712.png)

计算机与外界局域网的连接是通过**适配器**（**网卡**）进行的，**网卡**包含了数据链路层和物理层两个层次的功能，如图所示，网卡内具有处理器和存储器，网卡和局域网之间的通信通过双绞线串行传输，网卡和计算机之间通过主板上的**I/O**总线并行传输，因为网络上的数据率和计算机总线上的数据率并不相同，因此网卡中必须装有对数据进行缓存的存储芯片，网卡的设备驱动程序需安装在操作系统中，这个设备驱动程序告诉网卡该从存储器的什么位置上把多长的数据块发送到局域网，或者反过来，网卡具有串并相互转换的功能。

当计算机要发送IP数据报时，就由协议栈把IP数据报向下交给适配器，组装成帧发送到局域网。当适配器收到正确的帧时，通过中断来通知计算机，并交付给协议栈中的网络层。



**CSMA/CD 协议**
 以太网采用CSMA/CD协议的方式来协调总线上各计算机的工作。在使用CSMA/CD协议的时候，一个站不可能同时进行发送和接收，因此使用CSMA/CD协议的以太网不可能进行全双工通信而只能进行双向交替通信（半双工）。

**CSMA/CD**是**载波监听多点接入/碰撞检测**（Carrier Sense Multiple Access with Collision Detection）的缩写

**CSMA/CD协议的要点：**

*  **“多点接入”**就是计算机以多点接入（动态媒体接入控制）的方式连接在一根总线上
* **“载波监听”**就是”发送前先监听”，即每一个站在发送数据前先要检测一下总线是否有其他站在发送数据，如有则暂时不要发送数据，要等到信道为空闲
* **“碰撞检测”**就是“边发送边监听”，若发现总线上至少有两个站同时在发送数据，表明产生了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送

把总线上的单程端到端传播时延记为τ，A 发送数据后，最迟要经过2τ才能知道自己发送的数据和其他站发送的数据有没有发生碰撞。只有经过2τ这段时间后还没有检测到碰撞，才能肯定这次发送不会发生碰撞，碰撞后的重传不是马上重传，而是遵从一定的算法来得到重传时间

显然，使用CSMA/CD协议的以太网只能进行**双向交替通信（半双工通信）**（需要变发送变监听）

`CSMA/CD`协议的要点：

* **准备发送**：网络层中传下来的IP数据报加上首尾，组成**以太网帧**，放入适配器的缓存中，检测信道
* **检测信道**：检测到信道空闲，并且在96比特时间内保持空闲，则发送这个帧
* **边发送边监听**：
  * *发送成功*：2τ内未检测到碰撞
  * *发送失败*：执行退避算法得到重发时间，进行重发

**使用集线器的星形拓扑**：使用集线器的以太网在物理上是一个星形网，但在逻辑上是一个总线网，各站共享逻辑上的总线，使用的还是**CSMA/CD**协议（更具体的说是各站中的**适配器**执行这个协议）

**集线器**工作在物理层，不进行碰撞检测，仅简单地转发比特。



**以太网的MAC层**

 **MAC地址**又叫做**硬件地址**或**物理地址**，实际上就是适配器地址或适配器标识符EUI-48（固化在适配器的ROM中）。高位24位：厂家，低位24位由厂家自行指派

当路由器通过适配器连接到局域网时，适配器上的硬件地址就用来标志路由器的某个接口，路由器如果同时连接到两个网络上，那么它就需要两个适配器和两个硬件地址

适配器具有**过滤功能**，收到**MAC帧**时，先检查其目的地址是否是本站地址，是就收下，否则丢弃

包括三种帧：

* **单播帧**：（一对一），收到的帧的目的地址与本地址相同
* **广播帧**：（一对全体），发送给本局域网上所有站点的帧（全1地址）
* **多播帧**：（一对多），发送给本局域网上一部分站点的帧



**MAC帧的格式**

![image-20210105184405237](Markdown图片/image-20210105184405237.png)

常用的以太网MAC帧格式有两种标准 ： DIX Ethernet V2 标准IEEE 的 802.3 标准。V2使用较多，如上图所示

前两个字段分别为6字长的目标地址和源地址字段。第三个字段是2字节的类型字段，用来标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议。后面数据字段46~1500字节，FCS字段4个字节。

以太网**MAC帧**前面的8个字节是起着让适配器的时钟与即将到达的字节流达成同步的作用

以太网在传送帧时，各帧之间需要有一定的间隙，所以以太网帧不需要帧结束界定符，也不需要使用字节插入来保证透明传输



#### 3.4 扩展的以太网

1. 在物理层扩展—集线器 
    现在，双绞线以太网成为以太网的主流类型，扩展主机和集线器之间的距离的一种简单方法就是使用光纤(通常是一对光纤)和一对光纤调制解调器。

光纤调制解调器的作用，是进行电信号和光信号的转换。

2. 在数据链路层扩展—网桥（自学习算法）
    **注：在数据链路层扩展以太网要使用网桥**
    网桥工作在数据链路层，它根据MAC帧的目的地址对收到的帧进行转发或过滤。当网桥收到一个帧时，并不是向所有的接口转发这个帧，而是检查此帧的目的MAC地址，然后再确定将该帧转发到哪一个接口，或者是把它丢弃(即过滤)。

3. 虚拟局域网-交换机
    多接口网桥即交换式集线器常称为以太网交换机。利用以太网交换机可以很方便地 实现虚拟局域网，虚拟局域网协议允许在以太网的帧格式中插入一个 4 字节的标识符，称为 VLAN 标记。



### 第4章. 网络层

网际协议IP是TCP/IP体系中两个最重要的协议之一，也是最重要的因特网标准协议之一。与IP协议配套是用的四个协议：
 1.**地址解析协议ARP**：是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题。==其他书都将其归为数据链路层（TCP/IP分层模型中）==
 2.**逆地址解析协议RARP**：是解决同一个局域网上的主机或路由器的硬件地址和IP地址的映射问题。==其他书都将其归为数据链路层（TCP/IP分层模型中）==（现在的**DHCP**协议包含了这种功能）
 3.**网际控制报文协议ICMP**：提供差错报告和询问报文，以提高IP数据交付成功的机会
 4.**网际组管理协议IGMP**：：用于探寻、转发本局域网内的组成员关系。

网络互连是指用**路由器**进行网络互连和路由选择



#### 4.2 网际协议IP

**IP 地址**就是给每个连接在因特网上的主机（或路由器）分配一个在全世界范围是唯一的 32 位的标识符

IP地址都由 **网络号** net-id（标志主机所在网络）和 **主机号** host-id（标志该网络中的主机号）组成。

分类的IP地址：（近年来使用无分类IP，这分类IP**已成为历史**）

<img src="Markdown图片/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTgwMTA3MDIzMDQxMzcy" alt="img" style="zoom:80%;" />

![图片来源网络](Markdown图片/aHR0cDovL2ltZy5ibG9nLmNzZG4ubmV0LzIwMTgwMTA3MDIzOTQzODIw)

 **主机号中全0表示网络地址，全1表示广播地址**（该网络的上的所有主机）

网络号字段全0表示**本网络**，网络号`127`作为**环回测试**之用

路由器仅根据目的主机所连接的网络号来转发分组

用转发器或网桥连接起来的若干局域网仍未一个网络（因为这些中间设备工作在数据链路层或物理层）

**硬件地址**是数据链路层和物理层使用的地址， **IP地址**是网络层和以上各层使用的地址，是一种逻辑地址

实际上IP地址是标志一台主机（或路由器）和一条链路的接口，一个路由器至少有两个IP地址

<img src="Markdown图片/image-20210106140046382.png" alt="image-20210106140046382"  />

* **在网络层只看到IP数据报**，在发送过程中，IP数据报的源地址和目的地址始终不变，经过的路由器的IP地址不出现在IP数据报的地址之中
* **在局域网的链路层中，只看到MAC帧**，MAC帧在不同的网络上传送时，MAC帧的源地址和目的地址发生变化，路由器收到MAC帧后丢弃原来的MAC地址，换上新的地址，这种变化上层的网络层看不见



**地址解析协议ARP**`很多书把这个放在了链路层，注意！！！`

网络层使用的是IP地址，但在实际网络的链路上传送数据帧时，最终还是得知道硬件地址

ARP是解决**同一个局域网上**的主机或路由器的 IP 地址和硬件地址的映射问题

每一个主机都设有一个ARP高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表，发送给主机B时，先在缓存中查看是否有主机B的IP地址对硬件地址的映射，有则直接发送，若无则在本局域网广播ARP请求，这个表经常动态更新

如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络

<img src="Markdown图片/image-20210106142654050.png" alt="image-20210106142654050" style="zoom:80%;" />

如图是IP数据报的格式，首部的前一部分是**20字节固定长度**（必有的）

*  **版本**：`IPV4`或`IPV6`
* **首部长度**：最小值是5，最大值是15，单位是4字节，若不是整数倍需填充
* **区分服务**：没啥用，用来获得更好的服务
* **总长度**：首部与数据长度之和，单位为字节，最大值为65535字节，但每一种数据链路层协议斗殴规定有一个数据帧中的数据字段最大长度，称为**最大传送单元MTU**，比如以太网的MTU值为1500字节，超过就得分片，**源主机分片，目的主机重组**，中间的路由器也可能分片（可能经过的网络使用不同的底层协议）
* **标识**：每产生一个数据报，计数器加一并赋值给标识字段，这个标识并不是序号，而是用于数据报过长分片时，这个标识被复制到所有的分片的标识中，在目的主机能够借助这个相同的标识进行重组数据报
* **标志**：3位长度，最低位指示*分片是否是最后一个*，中间位指示*能不能分片*
* **片偏移**：表明分组后该片在原分组中的相对位置
* **生存时间**：**TTL**，防止无法交付的数据报无限制地在网络中兜圈子耗费资源，经过一个路由器减一，减为零时丢弃并向源主机发送**ICMP时间超过报文**
* **协议**：UDP、TCP、ICMP、IGMP.....等协议
* **首部检验和**：只检验数据报的首部，不检验数据部分



**分组转发流程**

在路由表中，每一条路由主要是两个信息：（**目的网络地址**，**下一跳地址**）

发送数据报时，查找路由表，用ARP得到硬件地址，并将硬件地址放在MAC帧的首部，然后根据这个地址找到下一跳路由器

1.  从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。
2. 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行(3)。
3.  若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)
4.  若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行(5)。
5.  若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)
6. 报告转发分组出错。

主机（如个人计算机）也是有路由表的



#### 4.3 划分子网和构造超网

**划分子网**

两级IP地址缺陷：

* IP 地址空间的利用率有时很低
* 给每一个物理网络分配一个网络号会使**路由表变得太大**因而使网络性能变坏
* 两级的 IP 地址不够灵活，新网络需要申请

子网划分的基本思路：

* 划分子网纯属一个单位内部的事情，单位对外仍然表现为没有划分子网的网络
* 划分子网的方法是从主机号借用若干个位作为子网号：{网络号，子网号，主机号}
* 仍然是根据网络号找到本单位网络的路由器，路由器再根据网络号和子网号找到目的子网

所有网络都必须使用子网掩码，在路由器的路由表中同时也必须有子网掩码这一项，即使不划分子网，那就用默认子网掩码，默认掩码和不划分子网的IP地址位与就得到地址类别

子网掩码是一个网络或一个子网的重要属性，路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器

**构造超网（无分类编址CIDR）**

**CIDR（无分类域间路由选择）**的主要特点：

- CIDR消除了传统的A、B、C类地址以及划分子网的概念，用**网络前缀**代替网络号和子网号，后面的部分指明主机。因此，CIDR使IP地址从三级编址(使用子网掩码)，又回到了两级编址，但这已是无分类的两级编址。
- CIDR把网络前缀相同的连续的IP地址组成一个”CIDR地址块”只要知道CIDR地址块中的任何一个地址，就可以知道这地址块的起始地址(即最小地址)和最大地址，以及地址块中的地址数。

**地址掩码**：是一连串的1和0组成，而1的个数救赎网络前缀长度。在斜线记法中。斜线后面的数字就是地址掩码中1的个数。

**构成超网**：由于一个CIDR地址块中含有很多地址，所以在路由表中就利用CIDR地址块来查找目标网络，这种地址的聚合常称为路由聚合，也称构成超网。



#### 4.4 网际控制报文协议ICMP

为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用了ICMP，ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告

**ICMP**是网络层的协议，但是**ICMP**是封装在IP数据报中的，看起来像上层的协议

![image-20210106154620139](Markdown图片/image-20210106154620139.png)

ICMP报文的**种类**：

* **ICMP差错报告报文**
* **ICMP询问报文**

![image-20210106155309532](Markdown图片/image-20210106155309532.png)

差错报告：

* **终点不可达**：当路由器或主机不能交付数据报时向源点发送终点不可达报告
* **时间超过**：当路由器收到生存时间为0的数据报，除了丢弃它，还有向源点发送报告
* **参数问题**：首部字段有问题，丢弃并发送报告给源点
* **改变路由**：让主机知道下次发送给其他的路由，这个路由线路更快

询问报文：

* **回送请求和回答**：主机或路由器想特定的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文
* **时间戳请求和回答**：请求某台主机或路由器回答当前的日期和时间，用于时钟同步和时间测量

ICMP的一个重要应用就是分组网间探测`PING`，用来测试两台主机之间的连通性。`PING`使用了**ICMP回送请求和回答**，是应用层直接使用网络层ICMP的一个例子，它并没有通过运输层的TCP或UDP

另一个重要应用是`traceroute`，分别发送**TTL**从1递增的一连串IP数据报，内装有无法交付的UDP用户数据报，经过路由器TTL减一，减至0时发送**ICMP时间超过**报文，当到达主机时，由于封装的是无法交付的用户报，目的主机就会向源主机发送**ICMP终点不可达**报告（使用非法的目的端口），就可知道经过的路由器的IP地址及其往返时间



#### 4.5 互联网的路由选择协议

互联网采用分层次的路由选择协议

两大类路由选择协议：

- **内部网关协议 IGP**：一个自治系统内部使用的路由选择协议。有多种协议，如 RIP 和OSPF 协议。
- **外部网关协议EGP**：一个自治系统的边界，将路由选择信息传递到另一个自治系统中（两自洽系统可能使用不同的内部网关协议，需要EGP在系统间传递），目前使用的就是BGP

RIP协议的优缺点：

- RIP 存在的一个问题是当网络出现故障时，要经过比较长的时间才能将此信息传送到所有的路由器。
- RIP 协议最大的优点就是实现简单，开销较小。
- RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
- 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。

RIP是一种分布式的基于距离向量的路由选择协议，其主要特点：
 （1）仅和相邻路由器交换信息。
 （3）按固定的时间间隔交换路由信息，例如，每隔30秒。

OSPF最主要的特征就是使用分布式的链路状态协议，其主要特点：
 （1）使用洪泛法向本自治系统中所有路由器发送信息。
 （2）发送的信息是与本路由器相邻的所有路由器的链路状态。
 （3）只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。

BGP是不同自治系统的路由器之间交换路由信息的协议，它采用路径向量路由选择协议，其主要特点：
 （2）自治系统AS之间的路由选择必须考虑有关策略。
 （3）BGP只能力求寻找一条能够到达目的网络且比较好的路由，而并非要寻找一条最佳路由。

**路由器的构成**

![image-20210106164913015](Markdown图片/image-20210106164913015.png)

路由器是具有多个输入输出口的专用计算机，任务是转发分组

路由器结构可划分为两大部分：**路由选择**，**分组转发**

路由选择部分根据路由选择协议构造路由表，定期地和相邻路由器交换路由信息

分组转发部分根据路由表从合适的路由器端口发射出去，路由表一般仅包含目的网络和下一跳网络，而转发表是根据路由表得出的，而转发表项必须包含的某些MAC地址信息 

![image-20210106172355565](Markdown图片/image-20210106172355565.png)

当一个分组正在查找转发表，后面紧跟着从这个输入端口收到的另一个分组，则后到的分组必须排队，如上图所示

![image-20210106172922764](Markdown图片/image-20210106172922764.png)

输出端口的网络层处理模块中有一个缓冲区，当发送速率不足以发送过多的分组，这些分组就得排队，数据链路层处理模块把分组加上链路层的首部和尾部，交给物理层。



### 第5章. 运输层

#### 5.1 运输层协议概述

**网络层**为**主机**之间提供逻辑通信，而**运输层**为应用进程之间提供**端到端**的逻辑通信

运输层对收到的报文进行差错检测，而IP数据报只检验首部

运输层的两个主要协议：

*  **用户数据报协议 UDP**(User Datagram Protocol)
* **传输控制协议 TCP**(Transmission Control Protocol)

运输层传送的数据单元称为**TCP报文段**或**UDP用户数据报**

UDP 在传送数据之前不需要先建立连接。对方的运输层在收到 UDP 报文后，不需要给出任何确认。虽然 UDP 不提供可靠交付，但在某些情况下 UDP 是一种最有效的工作方式

TCP 则提供面向连接的服务，传送数据前须建立连接，TCP 不提供广播或多播服务。由于 TCP 要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销，如确认、流量控制、计数器以及连接管理等。这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源

运输层使用的标识进程的端口是**软件端口**（不能用进程号），软件端口是***应用层的各种协议进程与运输实体***进行层间交互的一种地址，而**硬件端口**是不同硬件设备进行交互的接口

端口号只具有本地意义，标志本计算机**应用层**中的各个进程和在**运输层**交互时的层间接口

客户发起通讯请求时，必须先知道对方服务器的IP地址和端口号，运输层的端口号分为下面三大类：

- 熟知端口号，数值一般为 0~1023
   一些常用的数值端口号：
   **FTP 21**
   **LELNET 23**
   **SMTP 25**
   **DNS 53**
   **TFTP 69**
   **HTTP 80**
   **SNMP 161**
   **SNMP(trap) 162**
- 登记端口号，数值为1024~49151，为没有熟知端口号的应用程序使用的
- 客户端口号或短暂端口号，数值为49152~65535，留给客户进程选择暂时使用，通信结束后不复存在



#### 5.2 用户数据报协议

UDP的主要特点：

- **UDP 是无连接的**，即发送数据之前不需要建立连接，当然发送结束后也没有连接可以释放
- **UDP 使用尽最大努力交付**，即不保证可靠交付，同时也不使用拥塞控制
- **UDP 是面向报文的**，UDP对应用层交下来的报文不合并也不拆分，保留这些报文的边界，报文的长度由应用程序决定
- **UDP 没有拥塞控制**，很适合多媒体通信的要求。
- **UDP 支持一对一、一对多、多对一和多对多的交互通信**
- **UDP 的首部开销小**，只有 8 个字节（TCP20个字节）

<img src="Markdown图片/image-20210107152232221.png" alt="image-20210107152232221"  />

* **源端口**：需要对方回信时选用，不需要时全0
* **目的端口**：
* **长度**：数据报的总长度，最小值是8（仅有首部）
* **检验和**：检测UDP数据报是否有错，有错丢弃

伪首部是用于目的主机对数据报检测错误时临时加上的，检验完即丢弃，加上后即可检查UDP用户数据报的源、目的端口号，UDP数据报的数据部分，和IP数据报的源、目的IP地址



#### 5.3 传输控制协议TCP概述

TCP的主要特点：

- **TCP 是面向连接的运输层协议**，使用前后须建立、释放TCP连接
- **每一条 TCP 连接只能有两个端点(endpoint)**，每一条 TCP 连接只能是点对点的（一对一）
- **TCP 提供可靠交付的服务**，无差错、不丢失、不重复、按序到达
- **TCP 提供全双工通信**，连接的两端都设有发送缓存和接收缓存
- **面向字节流**，**流（stream）**指的是流入到进程或从进程流出的字节序列

TCP根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少字节（UDP发送的报文长度是应用进程给出的），若进程给得过长，TCP可将其分片，若太短，则TCP可积累至足够长再发送

TCP连接的端点叫做**套接字（socket）**，套接字表示：套接字`socket`=（IP地址：端口号）如（192.1.1.1：80）

每一条TCP连接唯一地被通信两端的两个端点（即两个套接字）所确定，即：

 TCP连接 ::= {socket1，socket2} = {（IP1：port1），（IP2：port2）}

同一个IP地址可以有多个不同的TCP连接，而同一个端口号也可以出现在多个不同的TCP连接中



#### 5.4 可靠传输的工作原理

1. **停止等待协议**（发完一个分组就停止等待对方的回复，再发送下一个分组，缺点是效率太低）

   * **无差错情况**：如下图a所示

   <img src="Markdown图片/image-20210107162340799.png" alt="image-20210107162340799" style="zoom: 80%;" />

   * **出现差错**：如上图b所示，B收到后检测分组出错，直接丢弃，超过定时器定下的时间后A重传，称为**超时重传**
   * **确认丢失和确认迟到**：如下图a所示，B回复的确认丢失了，A超时重传，B收到重复的M1将其丢弃并再次回复确认消息，下图b是确认迟到了，A超时重传，B收到重复的M1将其丢弃并再次回复确认消息，A收到迟到的确认消息将其丢弃

<img src="Markdown图片/image-20210107163050640.png" alt="image-20210107163050640" style="zoom:80%;" />

**信道利用率**：停止等待协议简单却效率低，可采用流水线传输提高利用率，要用到**连续ARQ协议**和**滑动窗口协议**

![image-20210107163433471](Markdown图片/image-20210107163433471.png) ![image-20210107163535967](Markdown图片/image-20210107163535967.png)

![image-20210107163751280](Markdown图片/image-20210107163751280.png)



2. **连续ARQ协议**

![image-20210107164336615](Markdown图片/image-20210107164336615.png)

如图，发送窗口的5个分组可连续发送，不需等待对方确认，每收到一个确认，发送窗口就向前移动一位



#### 5.5 TCP报文段的首部格式

<img src="Markdown图片/image-20210107164917584.png" alt="image-20210107164917584"  />

*  **源端口、目的端口**：各16位
* **序号**：序号是**建立在传送的字符流之上的，**而不是建立在传送的报文段的序列之上，整个传输的字节流的起始序号必须在连接建立时设置，如一报文段的序号是301，携带的数据长度是100字节，则下一个报文段的序号应为401
* **确认号**：期望收到对方的**下一个报文段的第一个数据字节的序号**，如B收到了A的序号为`501`，数据长度`200`的报文段，则B回复的确认报文段中把确认号置为`701`
* **数据偏移**：TCP的首部长度，单位是4字节
* **保留**：没啥用
* **紧急URG**：表面数据是否紧急，为1时紧急指针字段才有效
* **确认ACK**：ACK=1时确认号字段才有效，在连接建立后所有传送的报文段都必须把ACK置1
* **推送PSH**：接收到PSH为1的报文段时，立即向上交付给进程，而不用等待缓存填满
* **复位RST**：RST=1时表明连接出现严重差错，须释放连接再重新连接
* **同步SYN**：在连接建立时用来同步序号，SYN=1、ACK=0的报文段表明这是一个连接请求报文段，对方同意建立连接则回复SYN=1、ACK=1
* **终止FIN**：用来释放一个连接，当FIN=1时表明此报文段的发送方的数据已发送完毕，并要求释放连接
* **窗口**：值的是报文段发送方的**接收窗口**，告诉对方：从本报文段的确认号算起，接收方目前允许对方发送的数据量（之所以有这个限制是因为接收方的数据缓存空间是有限的），**窗口值作为接收方让发送方设置其发送窗口的依据**，如确认号是701，窗口段是1000，就是告诉对方从701号算起，我的接收缓存空间还可接收1000字节数据，`窗口字段明确指出了现在允许对方发送的数据量，窗口值经常动态变化`
* **检验和**：检验首部和数据段，和UDP一样，检验时需要加上伪首部
* **紧急指针**：在URG=1时才有效，指出紧急数据的字节数，**注意**：即使窗口为0也可发送紧急数据
* **选项**：长度可变，最长为40字节



#### 5.6 TCP可靠传输的实现

![image-20210107203759592](Markdown图片/image-20210107203759592.png)

如上图，A收到了确认号31，窗口值20，则可构造自己的发送窗口，窗口内的数据可以在收到确认前都可以发送出去，已发送的数据在收到确认前须暂时保留，以便超时重传，若收到新的确认号，窗口可向前滑动

![image-20210107205022221](Markdown图片/image-20210107205022221.png)

发送缓存用来暂时缓存：

* 应用程序待发送的数据
* TCP已发送出但尚未收到确认的数据

接收缓存用来暂时缓存：

* 按需到达，但尚未被应用程序读取的数据
* 未按序到达的数据

TCP通常将不按序到达的数据临时存放在接收窗口中，等到缺少的字节收到后，再**按序**交付上层的应用进程，接收方必须具有**累积确认**的功能，这样可减少传输开销

超时重传时间是动态变化的



#### 5.7 TCP的流量控制

**流量控制**就是让发送方的发送速率不要太快，要让接收方来得及接收，可利用滑动窗口机制实现对发送方的流量控制

![image-20210107213637154](Markdown图片/image-20210107213637154.png)

上图中，接收方B进行了三次流量控制，若过段时间后B的接收缓存有了新的空间，向A发送新窗口值，若丢失则会造成死锁，因此每个连接都有一个**持续计时器**，当一方接收到零窗口通知时就启动持续计时器，到时间后就发送一个**探测报文段**，若对方回复的窗口值仍是零则重置计时器，否则就打破死锁



#### 5.8 TCP的拥塞控制

**拥塞**：若对网络中某一资源（如带宽等）的需求超过了该资源所能提供的可用部分，网络的性能就要变坏

拥塞往往是多因素引起的，拥塞常常趋于恶化

**拥塞控制**就是防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载，拥塞控制是一个**全局性**的过程，涉及到所以的主机、路由器等，而**流量控制**往往是值点对点通信量的控制，是个**端到端**的问题（接收端控制发送端）

许多情况下，正是拥塞控制机制本身成为网络性能恶化的原因

为了进行拥塞控制，TCP的发送方维持一个拥塞窗口cwnd的状态变量。拥塞窗口的大小取决于网络的拥塞状态，并且动态地变化，发送方让自己的发送窗口取为拥塞窗口和接收方的接收窗口中较小的一个

拥塞控制采用四种算法：**慢开始、拥塞避免、快重传、快恢复**

……（==有需要再看书，内容太多……==）



#### 5.9 TCP的运输连接管理

**TCP连接**的过程叫握手，需要**三次握手**（大多数是客户端发起的）

![image-20210108141257459](Markdown图片/image-20210108141257459.png)

1. A向B发送连接请求报文，同步位SYN=1，SYN=1的报文段不能携带数据，但要消耗一个序号，此时客户进程处于`SYN_SENT`**同步发送**状态（SYN=1的报文段称为SYN报文段）
2. B收到请求报文，发送SYN=1、ACK=1的报文段，不能携带数据（SYN=1），同样消耗掉一个序号，seq是自己的初始序号，确认号是x+1，进入`SYN_RCVD`**同步收到**状态
3. 收到B的确认后，A向B发出确认，ACK=1，A进入`ESTABLISHED`已建立连接状态，B收到A的回复后也进入`ESTABLISHED`状态，ACK报文段可携带数据，若不携带，则不消耗序号，而SYN报文段会消耗

A的最后一次确认是为了防止以下情况：假如A发送的连接请求滞留在网络中，A超时重传建立连接传完数据后断开连接，此后一开始的连接请求到达B，B以为A又请求连接，于是发送回复给A，若设定的是不需要A的二次确认即可连接，则新的连接建立，浪费了B的资源，但是采用三次握手后，A收到回复后将其丢弃，不发送确认给B，B收不到A的确认，知道A没有请求建立连接，就可避免上述的情况

![image-20210108144711231](Markdown图片/image-20210108144711231.png)

**TCP释放连接**（**四次握手**）

1. 释放连接前，双方都处于`ESTABLISHED`状态，客户A向B发送FIN=1的报文段，A进入`FIN-WAIT-1`（终止等待1）状态，FIN=1耗掉一位序号
2. B收到后发出ACK=1的报文段，进入`CLOSE-WAIT`（关闭等待）状态，TCP服务器进程通知高层应用进程，A到B方向的连接就释放了，TCP连接处于**半关闭**状态，A没有数据向B发送了，但B到A方向的连接并未关闭，若B要发送数据，A仍要接收，这个状态可能要持续一段时间（只是关闭了A的发送缓冲区和B的接收缓冲区）
3. A收到B的确认后，进入`FIN-WAIT-2`（终止等待2）状态，等待B的连接释放报文段
4. B发送完数据后（如果有），向A发送FIN=1的报文段，B进入`LAST-ACK`（最后确认）状态，等待A的确认
5. A收到B的连接释放报文段后，还要向B发出确认，A进入`TIME-WAIT`，此时TCP连接并未释放掉，需经过`2MSL`（Maximum Segment Lifetime最长报文段寿命）后A进入`CLOSED`状态，结束TCP连接

等待2个MSL的理由：

* A最后发送的ACK报文段可能丢失，B收不到会超时重传FIN，A再次发送ACK报文，从而避免B无法进入`CLOSED`状态
* 保证本次连接过程中的所有报文都从网络中消失，防止“已失效的连接请求报文段”的旧连接出现在新连接中



**TCP的有限状态机**

![image-20210108151653003](Markdown图片/image-20210108151653003.png)

粗实箭头表示对客户进程的正常变迁，粗虚箭头表示对服务器进程的正常变迁，细线箭头表示异常变迁

> 基于应用程序所看到的数据是一个整体， 或说是一个流（stream），在底层通讯中这些数据可能被拆成很多数据包来发送，但是一个数据包有多少字节对应用 程序是不可见的，因此 TCP 协议是面向流的协议。而 UDP 是面向消息的协议，每个 UDP 段都是一条消息，应用程 序必须以消息为单位提取数据，不能一次提取任意字节的数据，这一点和 TCP 是很不同的

可用`netstat -apn | grep 端口号/client/server`查看网络状态



### 第6章. 应用层

